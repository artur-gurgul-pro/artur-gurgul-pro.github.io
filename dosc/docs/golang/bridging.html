<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artur Gurgul- Golang bridging</title>
  <meta name="author" content="Artur Gurgul" />
  <!-- <meta name="description" content="The blog of Artur Gurgul" />
  <link rel="canonical" href="artgur.net/golang/bridging.html" />
    -->
  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Artur Gurgul" href="artgur.net/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-k2/8zcNbxVIh5mnQ52A0r3a6jAgMGxFJFE2707UxGCk= sha512-ZV9KawG2Legkwp3nAlxLIVFudTauWuBpC10uEafMHYL0Sarrz5A7G79kXh5+5+woxQ5HM559XX2UZjMJ36Wplg==" crossorigin="anonymous">
  <style>
    #post pre {
      background-color: white;
      border-left: 12px solid #eee;
      padding: 0 .8em;
    }

    #post code {
      background-color: transparent;
    }

    .highlight {
      background-color: #333;
    }
    #stalker {
      float: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="four columns sidebar no-print">
      <nav>
  <h1><!-- Here might the title --></h1>
  <a href="/">
    
    <img src="/logo.png" id="logo" alt="Blog logo"/>
    
  </a>
  <h2 style="font-size: 16px;">Hi. I'm <a href="/"> Artur Gurgul </a>.</h2>
  <!-- <div id="bio">
  </div> -->
  <div id="social">
    <div id="stalker" style="text-align: center; width:100%">
  
  <a title="artur-gurgul on Github" href="https://github.com/artur-gurgul">
    <i class="fa fa-github-square"></i>
  </a>
  

  

  

  

  
  <a title="Artur Gurgul on Stack Overflow" href="http://stackoverflow.com/users/743268">
    <i class="fa fa-stack-overflow"></i>
  </a>
  

  
  <a title="ArturGurgul on Twitter" href="https://twitter.com/ArturGurgul">
    <i class="fa fa-twitter-square"></i>
  </a>
  

  

  

  

  

  

  
</div>

  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <p class="meta">
  October 19, 2016 
  <a href="/">
    <i class="home fa fa-home"></i>
  </a>
</p>

<h1 class="title">Golang bridging</h1>

<div id="post">
  <p>The Go tools are capable of static and dynamic linking with other libraries, and also there is possbility to create static and dynamic library, therefore it is possible to create a bridge between golang and the other language both ways.</p>

<h3 id="creating-shared-and-static-library-in-go">Creating shared and static library in Go</h3>

<p>Let’s create library we will use in external systems. Here is an example. File <code class="highlighter-rouge">example.go</code>:</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="s">"C"</span><span class="x">
</span><span class="k">import</span><span class="x"> </span><span class="s">"fmt"</span><span class="x">

</span><span class="c">//export SayHello</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">SayHello</span><span class="p">(</span><span class="n">hello</span><span class="x"> </span><span class="o">*</span><span class="n">C</span><span class="o">.</span><span class="n">char</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">GoString</span><span class="p">(</span><span class="n">hello</span><span class="p">))</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{}</span></code></pre></figure>

<p>and <code class="highlighter-rouge">Makefile</code> that will contain build script that you can invoke by <code class="highlighter-rouge">make static</code> or <code class="highlighter-rouge">make shared</code>. I am not sure if my solution present shows a good practice. Feel free to send a PR with improvement.</p>

<figure class="highlight"><pre><code class="language-make" data-lang="make"><span class="nl">static example.a</span><span class="o">:</span>
	go build -o example.a -buildmode<span class="o">=</span>c-archive example.go
<span class="nl">shared example.dylib</span><span class="o">:</span>
	<span class="err">go build -o example.dylib -buildmode=c-shared example.go</span></code></pre></figure>

<p>As far as I understand the main function is neccecery to include into library, because the final product has to have for example GC rutines. The comment starting from <code class="highlighter-rouge">//export {function name}</code> tells the comiler that this the function will be called from the outside.</p>

<h3 id="calling-functrion-from-library-in-go">Calling functrion from library in Go</h3>

<p>First off we will create C++ library that we will use in out Go program.
File <code class="highlighter-rouge">example.cxx</code>:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">void</span> <span class="n">PrintHello</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Hello: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}</span></code></pre></figure>

<p>And <code class="highlighter-rouge">example.hxx</code>:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#pragma once
</span><span class="kt">void</span> <span class="n">PrintHello</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">u</span><span class="p">)</span></code></pre></figure>

<p><code class="highlighter-rouge">extern "C" {}</code> informs the compiler that we want the function names to be preserved. That is, to not “mangle” the names as is done for C++ code.
<code class="highlighter-rouge">Makefile</code>:</p>

<figure class="highlight"><pre><code class="language-make" data-lang="make"><span class="nl">static example.a</span><span class="o">:</span>
	clang++ -c -Wall -o lib.o ./example.cxx
	ar rc ./libexample.a ./lib.o
<span class="nl">shared example.dylib</span><span class="o">:</span>
	<span class="err">clang++ -dynamiclib -o libexample.dylib example.cxx</span></code></pre></figure>

<h4 id="statically-linking-an-example-library">Statically linking an example library</h4>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="c">// #cgo CFLAGS: -I.</span><span class="x">
</span><span class="c">// #cgo LDFLAGS: -L. -lexample</span><span class="x">
</span><span class="c">//</span><span class="x">
</span><span class="c">// #include &lt;example.hxx&gt;</span><span class="x">
</span><span class="k">import</span><span class="x"> </span><span class="s">"C"</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">C</span><span class="o">.</span><span class="n">PrintHello</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">CString</span><span class="p">(</span><span class="s">"Hello Golang"</span><span class="p">))</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<p>The program is linked staticaly with libexample when you build it.</p>

<h4 id="example-of-using-library-with-ffi">Example of using library with FFI</h4>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">gem install ffi</code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'ffi'</span>
<span class="k">module</span> <span class="nn">Example</span>
  <span class="kp">extend</span> <span class="no">FFI</span><span class="o">::</span><span class="no">Library</span>
  <span class="n">ffi_lib</span> <span class="s1">'./example.dylib'</span>
  <span class="n">attach_function</span> <span class="ss">:SayHello</span><span class="p">,</span> <span class="p">[</span><span class="ss">:string</span><span class="p">]</span>
<span class="k">end</span>

<span class="no">Example</span><span class="o">.</span><span class="no">SayHello</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">)</span></code></pre></figure>

<p>More informations about FFI: https://en.wikipedia.org/wiki/Foreign_function_interface</p>

<h4 id="call-shared-library-from-python">Call shared library from Python</h4>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s">'./example.dylib'</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">SayHello</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">)</span></code></pre></figure>

<h2 id="interesting-websites">Interesting websites</h2>

<ul>
  <li>https://blog.filippo.io/building-python-modules-with-go-1-5/</li>
  <li>https://id-rsa.pub/post/go15-calling-go-shared-libs-from-firefox-addon/</li>
</ul>

</div>

<!--  comments comes from github like https://api.github.com/repos/artur-gurgul/artur-gurgul.markdown/issues/1/comments -->

<!-- 
<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>22 Dec 2020 &raquo;</span> <a href="/git/squash.html">Git - squasing commits</a>
    </li>
    
    <li>
      <span>19 Oct 2020 &raquo;</span> <a href="/linux/recepies/archlinux-install-media.html">[DRAFT] Install media for archlinux</a>
    </li>
    
    <li>
      <span>19 Oct 2020 &raquo;</span> <a href="/regex/regex-find-any.html">Regex: Find any</a>
    </li>
    
  </ul>

</div>
-->
        
    <ul class="tag_list_in_post"></ul>

      <div class="footer">
        <div class="disclaimer">
  
  <p>
  I do not clame that everyting on this webpage is correct. Feel free to contribute to this blog on <a href="https://github.com/artur-gurgul/artur-gurgul.github.io/issues">GitHub</a> 
  </p>
  

  <p>
  © Artur Gurgul, 2016 &mdash; Public Domain Licence [<a href="/cv/">My resume</a>]
  </p>
</div>

      </div>
    </div>
  </div>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41036379-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
