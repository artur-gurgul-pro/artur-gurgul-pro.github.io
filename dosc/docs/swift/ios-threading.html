<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artur Gurgul- iOS - Threading</title>
  <meta name="author" content="Artur Gurgul" />
  <!-- <meta name="description" content="The blog of Artur Gurgul" />
  <link rel="canonical" href="artgur.net/swift/ios-threading.html" />
    -->
  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Artur Gurgul" href="artgur.net/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-k2/8zcNbxVIh5mnQ52A0r3a6jAgMGxFJFE2707UxGCk= sha512-ZV9KawG2Legkwp3nAlxLIVFudTauWuBpC10uEafMHYL0Sarrz5A7G79kXh5+5+woxQ5HM559XX2UZjMJ36Wplg==" crossorigin="anonymous">
  <style>
    #post pre {
      background-color: white;
      border-left: 12px solid #eee;
      padding: 0 .8em;
    }

    #post code {
      background-color: transparent;
    }

    .highlight {
      background-color: #333;
    }
    #stalker {
      float: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="four columns sidebar no-print">
      <nav>
  <h1><!-- Here might the title --></h1>
  <a href="/">
    
    <img src="/logo.png" id="logo" alt="Blog logo"/>
    
  </a>
  <h2 style="font-size: 16px;">Hi. I'm <a href="/"> Artur Gurgul </a>.</h2>
  <!-- <div id="bio">
  </div> -->
  <div id="social">
    <div id="stalker" style="text-align: center; width:100%">
  
  <a title="artur-gurgul on Github" href="https://github.com/artur-gurgul">
    <i class="fa fa-github-square"></i>
  </a>
  

  

  

  

  
  <a title="Artur Gurgul on Stack Overflow" href="http://stackoverflow.com/users/743268">
    <i class="fa fa-stack-overflow"></i>
  </a>
  

  
  <a title="ArturGurgul on Twitter" href="https://twitter.com/ArturGurgul">
    <i class="fa fa-twitter-square"></i>
  </a>
  

  

  

  

  

  

  
</div>

  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <p class="meta">
  October 19, 2016 
  <a href="/">
    <i class="home fa fa-home"></i>
  </a>
</p>

<h1 class="title">iOS - Threading</h1>

<div id="post">
  <p>Threading is one of the most difficult things when you do programming. Fortunately, in comparisons to another frameworks, the Apple’s SDK handles the problem exceptionally well. At least it is my impression.</p>

<p>All chunks of job are arranged into <code class="highlighter-rouge">Blocks</code> or <code class="highlighter-rouge">Functions</code>/<code class="highlighter-rouge">Methods</code>. I’d like to mention that the <code class="highlighter-rouge">Blocks</code> have ability to capture their surrounding state. They close variables around that are in scope at the time the block is declared that’s why we call them also <code class="highlighter-rouge">Closures</code> <a href="http://pragmaticstudio.com/blog/2010/7/28/ios4-blocks-1">[1]</a></p>

<h4 id="kind-of-jobs-might-be-perform-in-the-separate-threads">Kind of jobs might be perform in the separate threads</h4>

<ul>
  <li>Computation intensive jobs: When the thread uses entire processing capability of CPU. The reasonable maximum number of the threads is the number of CPU cores. By crating more threads we cause unnecessary switching of the context by the CPU, which takes some unit of time therefore it makes the calculation slower.</li>
  <li>I/O intensive jobs: In that case we can trigger more threads than we have CPU cores and there is a formula how we can calculate how many thread is an optimal <code class="highlighter-rouge">Threads</code> = <code class="highlighter-rouge">Cores</code> / (1-<code class="highlighter-rouge">Blocking Factor</code>). Here the switch of CPU context itself does not impact much into performance, because the  thread probably is waiting for a signal anyway.</li>
</ul>

<h4 id="mutex-and-the-data-consistency">Mutex and the data consistency</h4>

<p>What makes threading difficult is the data consistency. Imagine the situation when there are two threads that have a pointer to the same array which suppose to contains unique items. Both threads can modify and read the array. Let’s say both of the threads want to append the same item at exactly the same time to this array. What they do is to check if the item already exists in the array so they iterate through the array for checking the item if it is a duplicate and if not both of them will append it.</p>

<p>The array will contains two the same items or even works the app will crash because the array might be mutated at the time the other threat iterate through it.</p>

<p>The solution is to use <code class="highlighter-rouge">mutex</code> for blocking threads in order to avoid override the data.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nv">mutex</span> <span class="o">=</span> <span class="nf">pthread_mutex_t</span><span class="p">()</span>
<span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
<span class="c1">// do atomic job</span>
<span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
<span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span></code></pre></figure>

<p>Another mechanism for syncing thread is semaphore, but you need to be aware of potential deadlock. Below you can see one</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">semaphore</span> <span class="o">=</span> <span class="kt">DispatchSemaphore</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">semaphore</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span> <span class="c1">// DEADLOCK</span>
<span class="n">semaphore</span><span class="o">.</span><span class="nf">signal</span><span class="p">()</span></code></pre></figure>

<p>The current thread stops and wait for a signal that can not be send in this case, because we try to send it from the same thread which is stopped.</p>

<p><a href="https://www.cocoawithlove.com/blog/2016/06/02/threads-and-mutexes.html">Article abut mutexes</a></p>

<h1 id="nsobject">NSObject</h1>
<p>The easiest way to start a new thread is to use a method that comes from base class <code class="highlighter-rouge">NSObject</code></p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="nf">performSelector</span><span class="p">(</span><span class="nv">inBackground</span><span class="p">:</span> <span class="kd">#selector(</span><span class="nf">job</span><span class="kd">)</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span></code></pre></figure>

<h1 id="gcd-grand-central-dispatch">GCD (Grand Central Dispatch)</h1>
<p>The <a href="https://github.com/apple/swift-corelibs-libdispatch">libdispatch</a> is a part of core library which takes care about threading.</p>

<p>In particular how to manage sync calls</p>

<ul>
  <li><code class="highlighter-rouge">dispatch_once</code>: Does not exists in SDK anymore <a href="http://stackoverflow.com/questions/37801407/whither-dispatch-once-in-swift-3">[1]</a> Here is an alternative</li>
</ul>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kd">lazy</span> <span class="k">var</span> <span class="nv">foo</span><span class="p">:</span> <span class="kt">Void</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Do this once</span>
<span class="p">}()</span></code></pre></figure>

<ul>
  <li><code class="highlighter-rouge">dispatch_sync</code>: locks the current thread until the passed block is executed on the separated thread</li>
  <li><code class="highlighter-rouge">dispatch_async</code>: starts executing the passed block on a separate thread, but the current one keeps running</li>
</ul>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// without "attributes" we will get serial queue</span>
<span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"important.job"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="o">.</span><span class="n">concurrent</span><span class="p">)</span>
<span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
	<span class="c1">// do stuff</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
	<span class="o">&lt;</span><span class="err">#</span><span class="n">code</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="n">code</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span></code></pre></figure>

<ol>
  <li><a href="https://www.raywenderlich.com/60749/grand-central-dispatch-in-depth-part-1">Raywenderlich article</a></li>
  <li><a href="https://developer.apple.com/library/content/documentation/General/Conceptual/ConcurrencyProgrammingGuide/OperationQueues/OperationQueues.html">serial vs concurrent queues</a></li>
  <li><a href="http://stackoverflow.com/questions/7078658/operation-queue-vs-dispatch-queue-for-ios-application">This answer says that “<code class="highlighter-rouge">NSOperationQueue</code> does use GCD on iOS 4.0 and later”</a>
it says also quote:
    <ul>
      <li>Prefer GCD where task is not much complex and optimum CPU performance is required.</li>
      <li>Prefer NSOperationQueue where task is complex and requires canceling or suspending a block and dependency management.</li>
    </ul>
  </li>
  <li><a href="http://www.appcoda.com/ios-concurrency/">Nice article that TODO: look at examples from the picture</a></li>
</ol>

<h1 id="nsthread">NSThread</h1>
<ul>
  <li>https://developer.apple.com/reference/foundation/thread
This is the most</li>
</ul>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">thread</span> <span class="o">=</span> <span class="kt">Thread</span><span class="p">(</span><span class="nv">target</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">selector</span><span class="p">:</span> <span class="kd">#selector(</span><span class="nf">job</span><span class="kd">)</span><span class="p">,</span> <span class="nv">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
<span class="c1">// or</span>
<span class="k">let</span> <span class="nv">thread</span> <span class="o">=</span> <span class="kt">Thread</span> <span class="p">{</span>
	<span class="o">&lt;</span><span class="err">#</span><span class="n">code</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
<span class="c1">// and then start the tread</span>
<span class="n">thread</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span></code></pre></figure>

<h1 id="nsoperationqueue">NSOperationQueue</h1>
<p><a href="https://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift">[1]</a></p>
<ul>
  <li>How to cancel NSOperationQueue</li>
</ul>

<h4 id="blueprint-of-nsoperation">Blueprint of NSOperation</h4>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="kt">MyVeryExpensiveOperation</span><span class="p">:</span> <span class="kt">Operation</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="c1">// Some chunk of time consuming task</span>
        <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">isCancelled</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="c1">// Some another chunk of time consuming task</span>
        <span class="c1">// and so on...</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h4 id="blueprint-of-nsoperationqueue">Blueprint of NSOperationQueue</h4>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">OperationQueue</span><span class="p">()</span>
<span class="n">queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Queue Name"</span>
<span class="n">queue</span><span class="o">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">let</span> <span class="nv">myOperation</span> <span class="o">=</span> <span class="kt">MyVeryExpensiveOperation</span><span class="p">()</span>
<span class="n">queue</span><span class="o">.</span><span class="nf">addOperation</span><span class="p">(</span><span class="n">myOperation</span><span class="p">)</span>
<span class="n">queue</span><span class="o">.</span><span class="n">addOperation</span> <span class="p">{</span>
	<span class="c1">// some another job passed by block</span>
<span class="p">}</span></code></pre></figure>

<h1 id="pthread-advancedjfyi">pthread (advanced/JFYI)</h1>
<p>There is no good idea to handle threads from low level because it affect highly into development time of an application, whoever as all of us we are curious about everything, so I am going to show you how to do <code class="highlighter-rouge">pthreading</code> on iOS. Here is an example:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nv">user_interactive_thread</span><span class="p">:</span> <span class="n">pthread_t</span><span class="p">?</span>
<span class="k">var</span> <span class="nv">user_interactive_qos_attr</span> <span class="o">=</span> <span class="nf">pthread_attr_t</span><span class="p">()</span>

<span class="n">return_value</span> <span class="o">=</span> <span class="nf">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_interactive_qos_attr</span><span class="p">)</span>
<span class="n">return_value</span> <span class="o">=</span> <span class="nf">pthread_attr_set_qos_class_np</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_interactive_qos_attr</span><span class="p">,</span> <span class="kt">QOS_CLASS_USER_INTERACTIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">return_value</span> <span class="o">=</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_interactive_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_interactive_qos_attr</span><span class="p">,</span> <span class="p">{</span> <span class="p">(</span><span class="nv">x</span><span class="p">:</span><span class="kt">UnsafeMutableRawPointer</span><span class="p">)</span> <span class="k">in</span>
	<span class="nf">print</span><span class="p">(</span><span class="s">"New pthread job"</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">},</span> <span class="kc">nil</span><span class="p">)</span></code></pre></figure>


</div>

<!--  comments comes from github like https://api.github.com/repos/artur-gurgul/artur-gurgul.markdown/issues/1/comments -->

<!-- 
<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>22 Dec 2020 &raquo;</span> <a href="/git/squash.html">Git - squasing commits</a>
    </li>
    
    <li>
      <span>19 Oct 2020 &raquo;</span> <a href="/linux/recepies/archlinux-install-media.html">[DRAFT] Install media for archlinux</a>
    </li>
    
    <li>
      <span>19 Oct 2020 &raquo;</span> <a href="/regex/regex-find-any.html">Regex: Find any</a>
    </li>
    
  </ul>

</div>
-->
        
    <ul class="tag_list_in_post"></ul>

      <div class="footer">
        <div class="disclaimer">
  
  <p>
  I do not clame that everyting on this webpage is correct. Feel free to contribute to this blog on <a href="https://github.com/artur-gurgul/artur-gurgul.github.io/issues">GitHub</a> 
  </p>
  

  <p>
  © Artur Gurgul, 2016 &mdash; Public Domain Licence [<a href="/cv/">My resume</a>]
  </p>
</div>

      </div>
    </div>
  </div>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41036379-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
