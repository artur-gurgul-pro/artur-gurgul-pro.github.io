<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artur Gurgul - Bridging between languages</title>
  <meta name="author" content="Artur Gurgul" />
  <meta name="description" content="The blog of Artur Gurgul" />
  
  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Artur Gurgul" href="http://localhost:4000/atom.xml" />
  <link rel="stylesheet" href="/assets/css/all.css">

  <style>
    #post pre {
      background-color: white;
      border-left: 12px solid #eee;
      padding: 0 .8em;
    }

    #post code {
      background-color: transparent;
    }

    #stalker {
      float: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="four columns sidebar no-print">
      <nav>
  <!-- <a href="/">
    <img src="/logo.png" id="logo" alt="Blog logo"/>
  </a>
  <div id="social">
    <div id="stalker" style="text-align: center; width:100%">
      
      <a title="artur-gurgul on Github" href="https://github.com/artur-gurgul">
        <i class="fa fa-github-square"></i>
      </a>
      
    
      
      <a title="Artur Gurgul on Stack Overflow" href="http://stackoverflow.com/users/743268">
        <i class="fa fa-stack-overflow"></i>
      </a>
      
    
    
      
      <a title="Artur Gurgul on LinkedIn" href="https://www.linkedin.com/in/gurgul">
        <i class="fa fa-linkedin-square"></i>
      </a>
      
      
    </div>
  </div>
   -->

   <h2 style="font-size: 20px;margin: 0px;">Hi. I'm <a href="/"> Artur Gurgul</a>,</h2>
   <h2 style="font-size: 15px;margin-top: -0.5em;">and this is my notepad.</h2>
  <hr class="hr-text" data-content="Contents"/>
  
  <ul id="blog-posts" class="posts">
    <!-- <li><span style="font-weight: bold; color: #3498db;">&raquo;</span><a href="/" style="font-weight: 600;">Selected</a></li> -->
  
    
    <li><span>&raquo;</span><a href="/regex/regex-find-any.html"
      
      

      >Regex - Find any</a></li>
  
    
    <li><span>&raquo;</span><a href="/software/debian/debian-sid.html"
      
      

      >Installing Debian sid on QEMU</a></li>
  
    
    <li><span>&raquo;</span><a href="/linux/recepies/power-management.html"
      
      

      >Ubuntu - Power management</a></li>
  
    
    <li><span>&raquo;</span><a href="/linux/recepies/creating-ram-disk.html"
      
      

      >Linux - RAM disk</a></li>
  
    
    <li><span>&raquo;</span><a href="/programming/bridging.html"
      
      
        style="font-weight: bold;"
      

      >Bridging between languages</a></li>
  
  </ul>



  
  
</nav>

    </div>

    <div class="eleven columns content">
      <h1 class="title">Bridging between languages</h1>

<div id="post">
  <p>Project written in X lang =&gt; compile to static/dynamic library =&gt; call the library from lang Y</p>

<h3 id="creating-shared-and-static-library-in-go">Creating shared and static library in Go</h3>

<p>An example code that is shared <a href="https://github.com/artur-gurgul/codebook"><code class="highlighter-rouge">example.go</code></a>:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="s">"C"</span><span class="x">
</span><span class="k">import</span><span class="x"> </span><span class="s">"fmt"</span><span class="x">

</span><span class="c">//export SayHello</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">SayHello</span><span class="p">(</span><span class="n">hello</span><span class="x"> </span><span class="o">*</span><span class="n">C</span><span class="o">.</span><span class="n">char</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Print</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">GoString</span><span class="p">(</span><span class="n">hello</span><span class="p">))</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{}</span><span class="x">
</span></code></pre>
</div>

<p>Creating static library</p>

<div class="highlighter-rouge"><pre class="highlight"><code>go build -o example.a -buildmode=c-archive example.go
</code></pre>
</div>

<p>Creating dynamic library</p>

<div class="highlighter-rouge"><pre class="highlight"><code>go build -o example.dylib -buildmode=c-shared example.go
</code></pre>
</div>

<p>As far as I understand the main function is neccecery to include into library, because the final product has to have for example the GC rutines. The comment starting from <code class="highlighter-rouge">//export {function name}</code> tells the comiler that this the function will be called from the outside.</p>

<p><img src="/svgs/test-graph.svg" alt="alt text" class="center-image" /></p>

<p>Inline:</p>

<p>
 <svg width="401px" class="center-image" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="-0.5 -0.5 402 252" content="&lt;mxfile host=&quot;Electron&quot; modified=&quot;2023-10-25T22:05:44.366Z&quot; agent=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/22.0.3 Chrome/114.0.5735.289 Electron/25.8.4 Safari/537.36&quot; etag=&quot;otsJfqcehWm7T3lQEhDT&quot; version=&quot;22.0.3&quot; type=&quot;device&quot;&gt;&lt;diagram name=&quot;Page-1&quot; id=&quot;Rsnn_ZEz_QR4m3hk7b2z&quot;&gt;3ZfLdtowEIafhmU5viRAltzSLNKTnrBom52wB1tU1riyHOw+fSVbMjYmJGlKbxuO5tfoMvNpZDHw50nxXpA0/oAhsIHnhMXAXww8bzy6Ur9aKGth5Lu1EAka1lJLWNHvYETHqDkNIes4SkQmadoVA+QcAtnRiBC467ptkHVXTUkEPWEVENZXP9FQxrU68cZ7/QZoFNuVXRtwQqyziSSLSYi7luQvB/5cIMq6lRRzYDp3Ni/1uOsnepuNCeDyJQMe7sROuEuerB/G/jfc3Iv76Tvf7E2WNmAIVfzGRCFjjJATttyrM4E5D0HP6ihr73OLmCrRVeIWpCwNTJJLVFIsE2Z61YZF+VmPH15a84uZrjIWRccqjbVBLufIUFQ79R1n5BC1jVkmBX6Fp3ssOM/MYcMzKdQRP5lTI2WYiwBOJNKeTSIikCf8vIa8qhjABFSAapwARiR97O6DmLMbNX57vKphCL+Ctpn3kbDcrLSN19veEegC3sVUwiolVfg7VeRdmBvKmE09Rw4mx9ckoUyDu0uBq+lXhGfnQ/gIQkJxGmI/6WbAha1Qc0VNjLnb17trXeJWrY+cM2HyjmDaxm/EdILJcYJ/Gyb/AJM3/tOcLnqc+rcpY+pLpVOqrv9UiwHDPPzpsnorlF/Awb3qcnDdF3KYnIvDZY/DNJAqGYcwLII8YbWDP9OZoOprf0vWwD5iRiVFrlzWKCUmLYcpo5HukHgACnPJKFfpt+8P57+4FC9HB9V2hLL/O4tt9Hyxtag0jy1NIyRZ3NyTxIAMVCJAHCGc0DBk7YpNikg/bYf1c9IbKl9Vw3KB+ZrBlTPVsl6ldPXi1YKFbnp1UyV5Ma6aZdOsproBzbIe8e+Ue0O9Xe7OkZPQiK84CsrcP4irvta/Cn/5Aw==&lt;/diagram&gt;&lt;/mxfile&gt;" style="background-color: rgb(255, 255, 255);">
  <path d="M 291 61 L 291 126 L 191 126 L 191 182.76" fill="none" stroke="#0060ad" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke" />
  <path d="M 191 188.76 L 187 180.76 L 191 182.76 L 195 180.76 Z" fill="#0060ad" stroke="#0060ad" stroke-width="2" stroke-miterlimit="10" pointer-events="all" />
  <rect x="231" y="1" width="120" height="60" fill="none" stroke="#0060ad" stroke-width="2" pointer-events="all" />
  <switch transform="translate(-0.5 -0.5)">
    <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
      <div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 31px; margin-left: 232px;">
        <div data-drawio-colors="color: #0060ad;" style="box-sizing: border-box; font-size: 0px; text-align: center;">
          <div style="display: inline-block; font-size: 12px; font-family: &quot;Open Sans&quot;; color: rgb(0, 96, 173); line-height: 1.2; pointer-events: all; font-weight: bold; white-space: normal; overflow-wrap: normal;">jhbj</div>
        </div>
      </div>
    </foreignObject>
    <text x="291" y="35" fill="#0060ad" font-family="Open Sans" font-size="12px" text-anchor="middle" font-weight="bold">jhbj</text>
  </switch>
  <rect x="131" y="191" width="120" height="60" fill="none" stroke="#0060ad" stroke-width="2" pointer-events="all" />
  <switch transform="translate(-0.5 -0.5)">
    <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
      <div style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 221px; margin-left: 132px;">
        <div data-drawio-colors="color: #0060ad;" style="box-sizing: border-box; font-size: 0px; text-align: center;">
          <div style="display: inline-block; font-size: 12px; font-family: &quot;Open Sans&quot;; color: rgb(0, 96, 173); line-height: 1.2; pointer-events: all; font-weight: bold; white-space: normal; overflow-wrap: normal;">jhjh</div>
        </div>
      </div>
    </foreignObject>
    <text x="191" y="225" fill="#0060ad" font-family="Open Sans" font-size="12px" text-anchor="middle" font-weight="bold">jhjh</text>
  </switch>
  <path d="M 31 51 C 7 51 1 71 20.2 75 C 1 83.8 22.6 103 38.2 95 C 49 111 85 111 97 95 C 121 95 121 79 106 71 C 121 55 97 39 76 47 C 61 35 37 35 31 51 Z" fill="none" stroke="#0060ad" stroke-width="2" stroke-miterlimit="10" pointer-events="all" />
  <ellipse cx="386" cy="138.5" rx="7.5" ry="7.5" fill="none" stroke="#0060ad" stroke-width="2" pointer-events="all" />
  <path d="M 386 146 L 386 171 M 386 151 L 371 151 M 386 151 L 401 151 M 386 171 L 371 191 M 386 171 L 401 191" fill="none" stroke="#0060ad" stroke-width="2" stroke-miterlimit="10" pointer-events="all" />
  <switch transform="translate(-0.5 -0.5)">
    <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
      <div style="display: flex; align-items: unsafe flex-start; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 198px; margin-left: 386px;">
        <div data-drawio-colors="color: #0060ad;" style="box-sizing: border-box; font-size: 0px; text-align: center;">
          <div style="display: inline-block; font-size: 12px; font-family: &quot;Open Sans&quot;; color: rgb(0, 96, 173); line-height: 1.2; pointer-events: all; font-weight: bold; white-space: nowrap;">Actor</div>
        </div>
      </div>
    </foreignObject>
    <text x="386" y="210" fill="#0060ad" font-family="Open Sans" font-size="12px" text-anchor="middle" font-weight="bold">Actor</text>
  </switch>
  <path d="M 1 151 L 71 151 L 71 176 L 81 176 L 81 166 L 101 186 L 81 206 L 81 196 L 71 196 L 71 221 L 46 221 L 46 231 L 56 231 L 36 251 L 16 231 L 26 231 L 26 221 L 1 221 Z" fill="none" stroke="#0060ad" stroke-width="2" stroke-miterlimit="10" pointer-events="all" />
  <switch>
    <a transform="translate(0,-5)" href="https://www.drawio.com/doc/faq/svg-export-text-problems" target="_blank">
      <text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text>
    </a>
  </switch>
</svg>
</p>

<h3 id="calling-functrion-from-library-in-go">Calling functrion from library in Go</h3>

<p>First off we will create C++ library that we will use in out Go program.
File <code class="highlighter-rouge">example.cxx</code>:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>

<span class="kt">void</span> <span class="n">PrintHello</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Hello: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}</span></code></pre></figure>

<p>And <code class="highlighter-rouge">example.hxx</code>:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#pragma once
</span><span class="kt">void</span> <span class="n">PrintHello</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">u</span><span class="p">)</span></code></pre></figure>

<p><code class="highlighter-rouge">extern "C" {}</code> informs the compiler that we want the function names to be preserved. That is, to not “mangle” the names as is done for C++ code.
<code class="highlighter-rouge">Makefile</code>:</p>

<figure class="highlight"><pre><code class="language-make" data-lang="make"><span class="nl">static example.a</span><span class="o">:</span>
	clang++ -c -Wall -o lib.o ./example.cxx
	ar rc ./libexample.a ./lib.o
<span class="nl">shared example.dylib</span><span class="o">:</span>
	<span class="err">clang++ -dynamiclib -o libexample.dylib example.cxx</span></code></pre></figure>

<h4 id="statically-linking-an-example-library">Statically linking an example library</h4>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="c">// #cgo CFLAGS: -I.</span><span class="x">
</span><span class="c">// #cgo LDFLAGS: -L. -lexample</span><span class="x">
</span><span class="c">//</span><span class="x">
</span><span class="c">// #include &lt;example.hxx&gt;</span><span class="x">
</span><span class="k">import</span><span class="x"> </span><span class="s">"C"</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">C</span><span class="o">.</span><span class="n">PrintHello</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">CString</span><span class="p">(</span><span class="s">"Hello Golang"</span><span class="p">))</span><span class="x">
</span><span class="p">}</span></code></pre></figure>

<p>The program is linked staticaly with libexample when you build it.</p>

<h4 id="example-of-using-library-with-ffi">Example of using library with FFI</h4>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">gem install ffi</code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'ffi'</span>
<span class="k">module</span> <span class="nn">Example</span>
  <span class="kp">extend</span> <span class="no">FFI</span><span class="o">::</span><span class="no">Library</span>
  <span class="n">ffi_lib</span> <span class="s1">'./example.dylib'</span>
  <span class="n">attach_function</span> <span class="ss">:SayHello</span><span class="p">,</span> <span class="p">[</span><span class="ss">:string</span><span class="p">]</span>
<span class="k">end</span>

<span class="no">Example</span><span class="o">.</span><span class="no">SayHello</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">)</span></code></pre></figure>

<p>More informations about FFI: https://en.wikipedia.org/wiki/Foreign_function_interface</p>

<h4 id="call-shared-library-from-python">Call shared library from Python</h4>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="s">'./example.dylib'</span><span class="p">)</span>
<span class="n">libc</span><span class="o">.</span><span class="n">SayHello</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">)</span></code></pre></figure>

<h2 id="interesting-websites">Interesting websites</h2>

<ul>
  <li>https://blog.filippo.io/building-python-modules-with-go-1-5/</li>
  <li>https://id-rsa.pub/post/go15-calling-go-shared-libs-from-firefox-addon/</li>
</ul>

</div>

        
    <ul class="tag_list_in_post"></ul>
      <div class="footer">
        <div class="disclaimer">
  <p>
  © Artur Gurgul, 2016 &mdash; Public Domain Licence
  </p>
</div>

      </div>
    </div>
  </div>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41036379-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
