<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artur Gurgul - Threading</title>
  <meta name="author" content="Artur Gurgul" />
  <meta name="description" content="The blog of Artur Gurgul" />
  
  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Artur Gurgul" href="http://localhost:4000/atom.xml" />
  <link rel="stylesheet" href="/assets/css/all.css">

  <style>
    #post pre {
      background-color: white;
      border-left: 12px solid #eee;
      padding: 0 .8em;
    }

    #post code {
      background-color: transparent;
    }

    #stalker {
      float: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="four columns sidebar no-print">
      <nav>
  <!-- <a href="/">
    <img src="/logo.png" id="logo" alt="Blog logo"/>
  </a>
  <div id="social">
    <div id="stalker" style="text-align: center; width:100%">
      
      <a title="artur-gurgul on Github" href="https://github.com/artur-gurgul">
        <i class="fa fa-github-square"></i>
      </a>
      
    
      
      <a title="Artur Gurgul on Stack Overflow" href="http://stackoverflow.com/users/743268">
        <i class="fa fa-stack-overflow"></i>
      </a>
      
    
    
      
      <a title="Artur Gurgul on LinkedIn" href="https://www.linkedin.com/in/gurgul">
        <i class="fa fa-linkedin-square"></i>
      </a>
      
      
    </div>
  </div>
   -->

   <h2 style="font-size: 20px;margin: 0px;">Hi. I'm <a href="/"> Artur Gurgul</a>,</h2>
   <h2 style="font-size: 15px;margin-top: -0.5em;">and this is my notepad.</h2>
  <hr class="hr-text" data-content="Contents"/>
  
  <ul id="blog-posts" class="posts">
    <!-- <li><span style="font-weight: bold; color: #3498db;">&raquo;</span><a href="/" style="font-weight: 600;">Selected</a></li> -->
  
    
    <li><span>&raquo;</span><a href="/swift/view-modifier.html"
      
      

      >Add share gesture as view modifier</a></li>
  
    
    <li><span>&raquo;</span><a href="/regex/regex-find-any.html"
      
      

      >Regex - Find any</a></li>
  
    
    <li><span>&raquo;</span><a href="/javascript/js-closure.html"
      
      

      >Javascript closure</a></li>
  
    
    <li><span>&raquo;</span><a href="/swift/dynamic-member-lockup.html"
      
      

      >Dynamic member lockup in swift</a></li>
  
    
    <li><span>&raquo;</span><a href="/software/debian/debian-sid.html"
      
      

      >Installing Debian sid on QEMU</a></li>
  
    
    <li><span>&raquo;</span><a href="/software/debian/debian-chroot.html"
      
      

      >Chroot environment of Debian sid</a></li>
  
    
    <li><span>&raquo;</span><a href="/swift/cancel-upstream.html"
      
      

      >Cancelling a publisher</a></li>
  
    
    <li><span>&raquo;</span><a href="/programming/bridging.html"
      
      

      >Bridging between languages</a></li>
  
    
    <li><span>&raquo;</span><a href="/linux/recepies/power-management.html"
      
      

      >Ubuntu - Power management</a></li>
  
    
    <li><span>&raquo;</span><a href="/linux/mounting-qcow2-image.html"
      
      

      >Linux - Mount disk from qcow2 image</a></li>
  
    
    <li><span>&raquo;</span><a href="/linux/recepies/creating-ram-disk.html"
      
      

      >Linux - RAM disk</a></li>
  
    
    <li><span>&raquo;</span><a href="/recepies.html"
      
      

      >Recepies</a></li>
  
    
    <li><span>&raquo;</span><a href="/swift/threading.html"
      
      
        style="font-weight: bold;"
      

      >Threading</a></li>
  
  </ul>



  
  
</nav>

    </div>

    <div class="eleven columns content">
      <h1 class="title">Threading</h1>

<div id="post">
  <p>Chunk of jobs that can be performed on the separate thread are arranged into:</p>

<ul>
  <li><code class="highlighter-rouge">Closures</code> or <code class="highlighter-rouge">Functions</code>/<code class="highlighter-rouge">Methods</code> and send to <code class="highlighter-rouge">DispatchQueue</code></li>
  <li>Classes and send as objects to <code class="highlighter-rouge">OperationQueue</code>. The queue can perform <code class="highlighter-rouge">Closure</code> as well</li>
</ul>

<h4 id="kinds-of-jobs">Kinds of jobs</h4>

<ul>
  <li>Computation intensive jobs: When the thread uses entire processing capability of <code class="highlighter-rouge">CPU</code>. The reasonable maximum number of the threads is the number of CPU cores.</li>
  <li>I/O intensive jobs: In that case we can trigger more threads than we have CPU cores. An optimal of threads is <code class="highlighter-rouge">Threads</code> = <code class="highlighter-rouge">Cores</code> / (1-<code class="highlighter-rouge">Blocking Factor</code>).</li>
</ul>

<h1 id="gcd-grand-central-dispatch"><a href="https://github.com/apple/swift-corelibs-libdispatch">GCD</a> (Grand Central Dispatch)</h1>

<p>Creating queue. Note without parameter <code class="highlighter-rouge">attributes</code> we will get serial queue</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"important.job"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="o">.</span><span class="n">concurrent</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="examples-of-sending-jobs-to-queues">Examples of sending jobs to queues:</h4>

<p>Send to the queue and proceed with the execution in the current context</p>
<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Same as above, but on main thread where UI operations should be done</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
     <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Perform on the global queue</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Send block that will be executed when all jobs sent at this point are completed. Stop current thread will the queue is done with the sent block.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">queue</span><span class="o">.</span><span class="nf">sync</span><span class="p">(</span><span class="nv">flags</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">barrier</span><span class="p">])</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Perform job in the time interval</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">queue</span><span class="o">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nv">after</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="o">.</span><span class="nf">now</span><span class="p">()),</span> <span class="nv">interval</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="dispatchgroup"><code class="highlighter-rouge">DispatchGroup</code></h3>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Sequence</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="n">threadedMap</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">mapper</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Element</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">T</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">output</span> <span class="o">=</span> <span class="p">[</span><span class="kt">T</span><span class="p">]()</span>
        <span class="k">let</span> <span class="nv">group</span> <span class="o">=</span> <span class="kt">DispatchGroup</span><span class="p">()</span>
        <span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">DispatchQueue</span><span class="p">(</span><span class="nv">label</span><span class="p">:</span> <span class="s">"queue-for--map-result"</span><span class="p">,</span> <span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">obj</span> <span class="k">in</span> <span class="k">self</span> <span class="p">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">group</span><span class="p">:</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">output</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nf">mapper</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">group</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="mutex">Mutex</h3>

<p>Performing max 3 tasks at the time</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">semaphore</span> <span class="o">=</span> <span class="kt">DispatchSemaphore</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
                
<span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="mi">15</span> <span class="p">{</span>
    <span class="n">queue</span><span class="o">.</span><span class="nf">async</span><span class="p">(</span><span class="nv">qos</span><span class="p">:</span> <span class="o">.</span><span class="n">background</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">semaphore</span><span class="o">.</span><span class="nf">wait</span><span class="p">()</span>
        <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
        <span class="n">semaphore</span><span class="o">.</span><span class="nf">signal</span><span class="p">()</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="locking-and-unlocking-the-thread">Locking and unlocking the thread</h3>

<p><strong>NSLock</strong></p>

<p>Example of usage. The concurrent queue becomes sort of serial. One job at the time, but execution in random order.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">lock</span> <span class="o">=</span> <span class="kt">NSLock</span><span class="p">()</span>
<span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="mi">1</span><span class="o">...</span><span class="mi">6</span> <span class="p">{</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="nf">lock</span><span class="p">()</span>
        <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
        <span class="n">lock</span><span class="o">.</span><span class="nf">unlock</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><strong>Mutex</strong></p>

<p>Same thing using <code class="highlighter-rouge">pthread</code> API</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">var</span> <span class="nv">mutex</span> <span class="o">=</span> <span class="nf">pthread_mutex_t</span><span class="p">()</span>
<span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">...</span><span class="mi">6</span> <span class="p">{</span>	
    <span class="n">queue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
        <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
        <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
        <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>When you are done with the lock, you need to release it</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
</code></pre>
</div>

<h1 id="nsoperationqueue"><code class="highlighter-rouge">NSOperationQueue</code></h1>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">queue</span> <span class="o">=</span> <span class="kt">OperationQueue</span><span class="p">()</span>
<span class="n">queue</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Queue Name"</span>
<span class="n">queue</span><span class="o">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre>
</div>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">MyVeryImportantOperation</span><span class="p">:</span> <span class="kt">Operation</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="c1">// Some chunk of time consuming task</span>
        <span class="k">if</span> <span class="n">isCancelled</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="c1">// Some another chunk of time consuming task</span>
        <span class="c1">// and so on...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Sending jobs to the queue</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">myOperation</span> <span class="o">=</span> <span class="kt">MyVeryExpensiveOperation</span><span class="p">()</span>
<span class="n">queue</span><span class="o">.</span><span class="nf">addOperation</span><span class="p">(</span><span class="n">myOperation</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">queue</span><span class="o">.</span><span class="n">addOperation</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Notes <code class="highlighter-rouge">NSOperationQueue</code> fit better when requires canceling, suspending a block and/or  dependency management</p>

<h1 id="nsthread">NSThread</h1>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">thread</span> <span class="o">=</span> <span class="kt">Thread</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="n">code</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span> <span class="err"> </span> 
</code></pre>
</div>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">thread</span> <span class="o">=</span> <span class="kt">Thread</span><span class="p">(</span><span class="nv">target</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span>
                    <span class="nv">selector</span><span class="p">:</span> <span class="kd">#selector(</span><span class="nf">jobMethod:</span><span class="kd">)</span><span class="p">,</span>
                    <span class="nv">object</span><span class="p">:</span> <span class="n">argumentObject</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">thread</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
</code></pre>
</div>

<h1 id="span-a-thread-in-nsobject-context">Span a thread in <code class="highlighter-rouge">NSObject</code> context</h1>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="nf">perform</span><span class="p">(</span><span class="kd">#selector(</span><span class="nf">job</span><span class="kd">)</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">waitUntilDone</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
</code></pre>
</div>

<h1 id="asyncawait">async/await</h1>

<p>Available from <code class="highlighter-rouge">Swift 5.5</code></p>

<p>TBD</p>

<p>Async method</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">doStuff</span><span class="p">()</span> <span class="n">async</span> <span class="p">{</span>
	<span class="o">&lt;</span><span class="err">#</span><span class="n">code</span><span class="err">#</span><span class="o">&gt;</span>
<span class="p">}</span>
</code></pre>
</div>
<h1 id="pthread">pthread</h1>

<p>This is an object that will be sent to the thread</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ThreadParameter</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">paramater</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This is a function that will be spanned on the background thread</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">threadedFunction</span><span class="p">(</span><span class="nv">pointer</span><span class="p">:</span> <span class="kt">UnsafeMutableRawPointer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UnsafeMutableRawPointer</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">threadParameter</span> <span class="o">=</span> <span class="n">pointer</span><span class="o">.</span><span class="nf">load</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="kt">ThreadParameter</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Creating  a <code class="highlighter-rouge">pthread</code></p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">var</span> <span class="nv">myThread</span><span class="p">:</span> <span class="n">pthread_t</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="k">let</span> <span class="nv">threadParameter</span> <span class="o">=</span> <span class="kt">ThreadParameter</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">pThreadParameter</span> <span class="o">=</span> <span class="kt">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="kt">ThreadParameter</span><span class="o">&gt;.</span><span class="nf">allocate</span><span class="p">(</span><span class="nv">capacity</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pThreadParameter</span><span class="o">.</span><span class="n">pointee</span> <span class="o">=</span> <span class="n">threadParameter</span>
        
<span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="nf">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myThread</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">threadedFunction</span><span class="p">,</span> <span class="n">pThreadParameter</span><span class="p">)</span>
</code></pre>
</div>

<p>waiting for finishing the thread</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="k">let</span> <span class="nv">myThread</span> <span class="p">{</span>
    <span class="nf">pthread_join</span><span class="p">(</span><span class="n">myThread</span><span class="p">,</span><span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">var</span> <span class="nv">mutex</span> <span class="o">=</span> <span class="nf">pthread_mutex_t</span><span class="p">()</span>
<span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
<span class="c1">// do atomic job</span>
<span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
<span class="nf">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">)</span>
</code></pre>
</div>

<h1 id="span-threads-using-combine-framework">Span threads using <code class="highlighter-rouge">Combine</code> framework</h1>
<h1 id="measure-a-performance-time">Measure a performance time</h1>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">startTime</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="o">&lt;</span><span class="err">#</span><span class="kt">Code</span> <span class="n">of</span> <span class="n">the</span> <span class="n">job</span><span class="err">#</span><span class="o">&gt;</span>
<span class="k">let</span> <span class="nv">endTime</span> <span class="o">=</span> <span class="kt">CFAbsoluteTimeGetCurrent</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="s">"Duration:</span><span class="se">\(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="se">)</span><span class="s"> seconds"</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="stop-thread-for-some-time">Stop thread for some time</h4>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre>
</div>


</div>

        
    <ul class="tag_list_in_post"></ul>
      <div class="footer">
        <div class="disclaimer">
  <p>
  © Artur Gurgul, 2016 &mdash; Public Domain Licence
  </p>
</div>

      </div>
    </div>
  </div>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-41036379-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
